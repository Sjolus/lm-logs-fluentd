# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will download a prebuilt Ruby version, install dependencies and run tests with Rake
# For more information see: https://github.com/marketplace/actions/setup-ruby-jruby-and-truffleruby

name: Ruby

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build
      run: docker build -t lm-logs-fluentd .
    - name: Start container
      run: id=$(docker create lm-logs-fluentd) && docker cp $id:/logicmonitor/release.gem .
    - name: Create directory for credentials
      run: mkdir ~/.gem && touch ~/.gem/credentials
    - name: Add credentials
      env:
        GEM_ACCOUNT_PASSWORD: ${{ secrets.GEM_ACCOUNT_PASSWORD }}
      run: curl -u ahsan13jan:$GEM_ACCOUNT_PASSWORD https://rubygems.org/api/v1/api_key.yaml > ~/.gem/credentials
    - name: Give access
      run: chmod 0600 ~/.gem/credentials
    - name: Gem push
      run: gem push release.gem
      